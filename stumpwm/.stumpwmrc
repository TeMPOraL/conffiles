;;; -*-lisp-*-
;;; Yay, my fist StumpWM config xD.

(in-package :stumpwm)
(ql:quickload :external-program)

(defun run-external-program (cmd args)
  (with-open-stream (s (make-string-output-stream))
    (external-program:run cmd args :output s)
    (string-trim '(#\Newline #\Space) (get-output-stream-string s))))

(defun current-hostname ()
  (run-external-program "hostname" '()))

(defun current-ips ()
  (run-external-program "hostname" '("-I")))

;;; mode line
(setf *mode-line-timeout* 1)

(setf *screen-mode-line-format*
      (list "%g|%v"
            "^>"
            " ^1"
            (current-hostname)
            "^n | "
            (current-ips)
            " | "
            "^B%d^b"))

(setf *time-modeline-string*
      "^b%a %b ^B%e^2 %H:%M:%S^n")

(defun cat (&rest strings) "Concatenates strings, like the Unix command 'cat'. A shortcut for (concatenate 'string foo bar)."
       (apply 'concatenate 'string strings))

;;; modeline
;(screen-mode-line-mode (current-screen) t)

;;; GROUPS
(defun group-exists-p (group-name)
  (find-if (lambda (group)
             (string= group-name
                      (group-name group)))
           (screen-groups (current-screen))))

(defun ensure-group (group-name)
  (unless (group-exists-p group-name)
    (stumpwm::run-commands (cat "gnewbg " group-name))))

(setf (group-name (first (screen-groups (current-screen)))) "Terminals") ;FIXME need to sort by group # first.

(ensure-group "Emacs")
(ensure-group "Browser")
(ensure-group "SQL")
(ensure-group "IRC")

;; bind g-e to switch to Emacs group.
;; bind g-b to switch to browser group.
;; bind g-t to switch to terminal group.

;;; TODO make some direct connection to Alice xD.

(defcommand color-map () ()
            "Show current color map."
            (echo-string (current-screen) "^0 0^1 1^2 2^3 3^4 4^5 5^6 6^7 7"))

;;; Hooks
(defun ensure-hook (hook fn)
  (remove-hook hook fn)
  (add-hook hook fn))

(defun my-modeline-click-hook (screen button x y)
  (message "Clicked: X:~A, Y:~A" x y))

;; FIXME
;; (ensure-hook *mode-line-click-hook* 'my-modeline-click-hook)
